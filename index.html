<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>æˆ‘çš„å°åº—</title>
  <style>
    body {
      font-family: "Microsoft JhengHei", sans-serif;
      background: #fdfaf5;
      margin: 0;
      padding: 20px;
      color: #444;
    }
    .container { max-width: 1000px; margin: 0 auto; }
    h1 { text-align: center; color: #6a8caf; margin-bottom: 30px; }
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
      gap: 15px;
    }
    .card {
      background: white;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 4px 10px rgba(0,0,0,0.08);
      display: flex;
      flex-direction: column;
    }
    .img-box {
      width: 100%;
      height: 160px;
      background: #f0f0f0;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      position: relative;
    }
    img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      transition: opacity 0.3s;
      display: block;
    }
    .info { padding: 12px; text-align: center; }
    .name {
      font-weight: bold;
      font-size: 14px;
      margin-bottom: 5px;
      height: 40px;
      overflow: hidden;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      line-height: 1.4;
    }
    .price { color: #e67e22; font-weight: bold; font-size: 16px; }
    .small { font-size: 12px; color: #888; margin-top: 6px; }
    .errorBox{
      max-width:1000px;margin:12px auto 0;
      padding:10px 12px;border:1px solid #f3c5c5;background:#fff6f6;color:#b00020;
      border-radius:10px;display:none;white-space:pre-wrap;
    }
  </style>
</head>

<body>
  <div class="container">
    <h1>âœ¨ æ­¡è¿å…‰è‡¨ âœ¨</h1>

    <div id="loading" style="text-align:center; padding:50px; color:#999;">
      ğŸšš è²¨å“é‹é€ä¸­...
    </div>

    <div id="errorBox" class="errorBox"></div>

    <div id="shop-content" class="grid"></div>
  </div>

  <script>
    // ====== 1) ä½ çš„ Apps Script APIï¼ˆè®€ Google Sheetï¼‰======
    const API_URL = 'https://script.google.com/macros/s/AKfycbzv6LyBK2hRBmz4H6t0qk3FLX946QxhILyL1Ni6DQM1b9_9OhZjBHP2_1U_dJMaRkv5/exec';

    // ====== 2) ä½ çš„ AppSheet è³‡è¨Šï¼ˆä½ å·²æä¾›ï¼‰======
    const APP_NAME  = 'GoogleSheetsç¯„ä¾‹èˆ‡å»ºè­°-594648220';
    const TABLE_NAME = 'Google Sheets ç¯„ä¾‹èˆ‡å»ºè­°';

    // ====== å°å·¥å…·ï¼šé¡¯ç¤ºéŒ¯èª¤ ======
    function showError(msg) {
      const box = document.getElementById('errorBox');
      box.style.display = 'block';
      box.textContent = msg;
    }

    // ====== 3) å°‡ç›¸ç‰‡æ¬„ä½è½‰æˆã€Œç©©å®šã€åœ–ç‰‡ URL ======
    function getImgUrl(cellData) {
      if (!cellData) return 'https://https://via.placeholder.com/600?text=No+Image/600?text=No+Image';

      let str = cellData.toString().trim();

      // å¤šå¼µç›¸åªå–ç¬¬ä¸€å¼µ
      if (str.includes(',')) str = str.split(',')[0].trim();

      // B æƒ…æ³ï¼šAppSheet è‡¨æ™‚ç¶²å€ï¼ˆå¸¶ signatureï¼‰â†’ è½‰ç©©å®šç¶²å€
      if (str.includes('appsheet.com/image/getimageurl')) {
        try {
          const u = new URL(str);
          const fileName = u.searchParams.get('fileName');
          if (fileName) {
            return 'https://www.appsheet.com/template/gettablefileurl'
              + '?appName=' + encodeURIComponent(APP_NAME)
              + '&tableName=' + encodeURIComponent(TABLE_NAME)
              + '&fileName=' + encodeURIComponent(fileName);
          }
        } catch (e) {
          // è§£æå¤±æ•—å°±ç…§åŸæ¨£
          return str;
        }
      }

      // å¦‚æœå·²ç¶“ä¿‚ http(s) URLï¼Œå°±ç›´æ¥ç”¨ï¼ˆä¾‹å¦‚ä½ å°‡ä¾†æ› Drive thumbnailï¼‰
      if (str.startsWith('http://') || str.startsWith('https://')) return str;

      // å…¶ä»–æƒ…æ³ï¼šå…ˆç•¶ç„¡åœ–
      return 'https://https://via.placeholder.com/600?text=No+Image/600?text=No+Image';
    }

    // ====== 4) ä¸»ç¨‹å¼ï¼šè¼‰å…¥å•†å“ ======
    async function loadShop() {
      const loadingEl = document.getElementById('loading');
      const content = document.getElementById('shop-content');

      try {
        const res = await fetch(API_URL, { cache: "no-store" });
        if (!res.ok) throw new Error('API HTTP ' + res.status);

        const raw = await res.json();

        // é˜²å‘†ï¼šæœ‰äº› API æœƒåŒ…ä¸€å±¤ {data: [...]}
        const data = Array.isArray(raw) ? raw : (raw && Array.isArray(raw.data) ? raw.data : null);
        if (!data) throw new Error('API å›å‚³æ ¼å¼å””ä¿‚é™£åˆ—ï¼Œè«‹æª¢æŸ¥ Apps Script å›å‚³ JSON');

        loadingEl.style.display = 'none';
        content.innerHTML = '';

        if (data.length === 0) {
          showError('Sheet æš«æ™‚å†‡è³‡æ–™ï¼ˆdata.length = 0ï¼‰ã€‚');
          return;
        }

        data.forEach(item => {
          // å…¼å®¹ã€Œç›¸ç‰‡1ã€åŒã€Œç›¸ç‰‡ 1ã€
          const imgCell = item['ç›¸ç‰‡1'] ?? item['ç›¸ç‰‡ 1'] ?? item['ç›¸ç‰‡ 1 '] ?? item['ç›¸ç‰‡ 1ã€€'];
         const finalUrl = item['ç›¸ç‰‡1_ç¶²å€'] || 'https://https://via.placeholder.com/600?text=No+Image/600?text=No+Image';


          const name = item['è²¨å“åç¨±'] ?? 'æœªå‘½å';
          const price = item['åƒ¹éŒ¢ (MOP)'] ?? item['åƒ¹éŒ¢(MOP)'] ?? item['åƒ¹éŒ¢'] ?? '0';

          const card = document.createElement('div');
          card.className = 'card';

          card.innerHTML =
            '<div class="img-box">' +
              '<img src="' + finalUrl + '" alt="å•†å“åœ–" ' +
              'onerror="this.onerror=null;this.src=\'https://https://via.placeholder.com/600?text=No+Image/600?text=åœ–ç‰‡è¼‰å…¥å¤±æ•—\';">' +
            '</div>' +
            '<div class="info">' +
              '<div class="name">' + escapeHtml(name) + '</div>' +
              '<div class="price">MOP ' + escapeHtml(String(price)) + '</div>' +
              '<div class="small">ï¼ˆè‡ªå‹•å¾ Sheet æ›´æ–°ï¼‰</div>' +
            '</div>';

          content.appendChild(card);
        });

      } catch (e) {
        loadingEl.style.display = 'none';
        showError('è¼‰å…¥å¤±æ•—ï¼š' + (e && e.message ? e.message : e));
        console.error(e);
      }
    }

    // é˜² XSS / äº‚ç¢¼ï¼ˆä¿éšªï¼‰
    function escapeHtml(s) {
      return String(s)
        .replaceAll('&', '&amp;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;')
        .replaceAll('"', '&quot;')
        .replaceAll("'", '&#039;');
    }

    loadShop();
  </script>
</body>
</html>
